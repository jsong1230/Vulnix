"""취약점 관련 요청/응답 스키마"""

import uuid
from datetime import datetime
from typing import Literal

from pydantic import BaseModel, Field


class PatchPRSummary(BaseModel):
    """패치 PR 요약 (취약점 상세에 포함)"""

    id: uuid.UUID
    github_pr_number: int | None
    github_pr_url: str | None
    status: str
    patch_diff: str | None
    patch_description: str | None

    model_config = {"from_attributes": True}


class VulnerabilityResponse(BaseModel):
    """취약점 응답 (설계서 4-3절)"""

    id: uuid.UUID
    scan_job_id: uuid.UUID
    repo_id: uuid.UUID
    status: Literal["open", "patched", "ignored", "false_positive"]
    severity: Literal["critical", "high", "medium", "low"]
    vulnerability_type: str
    cwe_id: str | None
    owasp_category: str | None
    file_path: str
    start_line: int
    end_line: int
    code_snippet: str | None
    description: str | None
    llm_reasoning: str | None
    llm_confidence: float | None
    semgrep_rule_id: str | None
    references: list[str] | None
    detected_at: datetime | None
    resolved_at: datetime | None
    created_at: datetime
    # 패치 PR 정보 (관계 데이터, null 가능)
    patch_pr: PatchPRSummary | None = None
    # 저장소 전체 이름 (표시용)
    repo_full_name: str | None = None

    model_config = {"from_attributes": True}


class VulnerabilityStatusUpdateRequest(BaseModel):
    """취약점 상태 변경 요청"""

    status: Literal["open", "patched", "ignored", "false_positive"] = Field(
        description="변경할 상태"
    )
    reason: str | None = Field(default=None, max_length=500, description="상태 변경 사유")
    # F-06: 오탐 패턴 자동 생성 옵션 (ADR-F06-003)
    create_pattern: bool = Field(
        default=False,
        description="오탐 패턴으로 등록 여부 (status=false_positive일 때만 적용)",
    )
    file_pattern: str | None = Field(
        default=None,
        max_length=500,
        description="오탐 패턴의 glob 파일 패턴 (미지정 시 취약점 파일 경로에서 자동 추론)",
    )
    pattern_reason: str | None = Field(
        default=None,
        description="오탐 패턴 등록 사유",
    )


class VulnerabilitySummary(BaseModel):
    """취약점 요약 (목록 조회용 경량 응답)"""

    id: uuid.UUID
    status: str
    severity: str
    vulnerability_type: str
    file_path: str
    start_line: int
    detected_at: datetime | None
    created_at: datetime

    model_config = {"from_attributes": True}
