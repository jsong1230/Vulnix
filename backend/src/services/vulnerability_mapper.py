"""VulnerabilityMapper — Semgrep rule_id를 취약점 메타데이터로 매핑하는 유틸리티.

design.md 3-3절 기준. F-05: 다국어 탐지 엔진 확장 (JavaScript, Java, Go 룰 추가).
"""

# Semgrep rule_id -> 취약점 메타데이터 매핑 테이블
RULE_MAPPING: dict[str, dict[str, str]] = {
    # ────────────────────────────────────────
    # Python — SQL Injection
    # ────────────────────────────────────────
    "vulnix.python.sql_injection.string_format": {
        "vulnerability_type": "sql_injection",
        "cwe_id": "CWE-89",
        "owasp_category": "A03:2021 - Injection",
    },
    "vulnix.python.sql_injection.string_concat": {
        "vulnerability_type": "sql_injection",
        "cwe_id": "CWE-89",
        "owasp_category": "A03:2021 - Injection",
    },
    "vulnix.python.sql_injection.sqlalchemy_text": {
        "vulnerability_type": "sql_injection",
        "cwe_id": "CWE-89",
        "owasp_category": "A03:2021 - Injection",
    },
    # Django SQL Injection 추가 룰
    "vulnix.python.sql_injection.django_raw": {
        "vulnerability_type": "sql_injection",
        "cwe_id": "CWE-89",
        "owasp_category": "A03:2021 - Injection",
    },
    "vulnix.python.sql_injection.django_extra": {
        "vulnerability_type": "sql_injection",
        "cwe_id": "CWE-89",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # Python — XSS
    # ────────────────────────────────────────
    "vulnix.python.xss.flask_render_html": {
        "vulnerability_type": "xss",
        "cwe_id": "CWE-79",
        "owasp_category": "A03:2021 - Injection",
    },
    "vulnix.python.xss.flask_markup_unsafe": {
        "vulnerability_type": "xss",
        "cwe_id": "CWE-79",
        "owasp_category": "A03:2021 - Injection",
    },
    "vulnix.python.xss.jinja2_autoescape_disabled": {
        "vulnerability_type": "xss",
        "cwe_id": "CWE-79",
        "owasp_category": "A03:2021 - Injection",
    },
    "vulnix.python.xss.django_mark_safe": {
        "vulnerability_type": "xss",
        "cwe_id": "CWE-79",
        "owasp_category": "A03:2021 - Injection",
    },
    # FastAPI XSS 추가 룰
    "vulnix.python.xss.fastapi_html_response": {
        "vulnerability_type": "xss",
        "cwe_id": "CWE-79",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # Python — Hardcoded Credentials
    # ────────────────────────────────────────
    "vulnix.python.hardcoded_creds.password_assignment": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A07:2021 - Identification and Authentication Failures",
    },
    "vulnix.python.hardcoded_creds.api_key": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A07:2021 - Identification and Authentication Failures",
    },
    "vulnix.python.hardcoded_creds.aws_access_key": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A07:2021 - Identification and Authentication Failures",
    },
    "vulnix.python.hardcoded_creds.db_connection_string": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A07:2021 - Identification and Authentication Failures",
    },
    # 추가 하드코딩 룰
    "vulnix.python.hardcoded_creds.jwt_secret": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A07:2021 - Identification and Authentication Failures",
    },
    "vulnix.python.hardcoded_creds.private_key": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A07:2021 - Identification and Authentication Failures",
    },

    # ────────────────────────────────────────
    # JavaScript / TypeScript — SQL Injection
    # ────────────────────────────────────────
    "vulnix.javascript.injection.sql_string_concat": {
        "vulnerability_type": "sql_injection",
        "cwe_id": "CWE-89",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # JavaScript / TypeScript — XSS
    # ────────────────────────────────────────
    "vulnix.javascript.xss.innerhtml_assignment": {
        "vulnerability_type": "xss",
        "cwe_id": "CWE-79",
        "owasp_category": "A03:2021 - Injection",
    },
    "vulnix.javascript.xss.document_write": {
        "vulnerability_type": "xss",
        "cwe_id": "CWE-79",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # JavaScript / TypeScript — Hardcoded Credentials
    # ────────────────────────────────────────
    "vulnix.javascript.crypto.hardcoded_key": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A02:2021 - Cryptographic Failures",
    },

    # ────────────────────────────────────────
    # JavaScript / TypeScript — Insecure JWT
    # ────────────────────────────────────────
    "vulnix.javascript.auth.jwt_no_verify": {
        "vulnerability_type": "insecure_jwt",
        "cwe_id": "CWE-347",
        "owasp_category": "A07:2021 - Identification and Authentication Failures",
    },

    # ────────────────────────────────────────
    # JavaScript / TypeScript — Misconfig
    # ────────────────────────────────────────
    "vulnix.javascript.misconfig.cors_wildcard": {
        "vulnerability_type": "security_misconfiguration",
        "cwe_id": "CWE-942",
        "owasp_category": "A05:2021 - Security Misconfiguration",
    },

    # ────────────────────────────────────────
    # JavaScript / TypeScript — Command Injection
    # ────────────────────────────────────────
    "vulnix.javascript.injection.command_exec": {
        "vulnerability_type": "command_injection",
        "cwe_id": "CWE-78",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # Java — SQL Injection
    # ────────────────────────────────────────
    "vulnix.java.injection.sql_string_concat": {
        "vulnerability_type": "sql_injection",
        "cwe_id": "CWE-89",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # Java — XSS
    # ────────────────────────────────────────
    "vulnix.java.xss.servlet_print_unsanitized": {
        "vulnerability_type": "xss",
        "cwe_id": "CWE-79",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # Java — Hardcoded Credentials
    # ────────────────────────────────────────
    "vulnix.java.crypto.hardcoded_key": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A02:2021 - Cryptographic Failures",
    },

    # ────────────────────────────────────────
    # Java — Weak Crypto
    # ────────────────────────────────────────
    "vulnix.java.crypto.weak_hash": {
        "vulnerability_type": "weak_crypto",
        "cwe_id": "CWE-328",
        "owasp_category": "A02:2021 - Cryptographic Failures",
    },
    "vulnix.java.crypto.insecure_random": {
        "vulnerability_type": "insecure_random",
        "cwe_id": "CWE-330",
        "owasp_category": "A02:2021 - Cryptographic Failures",
    },

    # ────────────────────────────────────────
    # Go — SQL Injection
    # ────────────────────────────────────────
    "vulnix.go.injection.sql_string_format": {
        "vulnerability_type": "sql_injection",
        "cwe_id": "CWE-89",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # Go — Command Injection
    # ────────────────────────────────────────
    "vulnix.go.injection.command_exec": {
        "vulnerability_type": "command_injection",
        "cwe_id": "CWE-78",
        "owasp_category": "A03:2021 - Injection",
    },

    # ────────────────────────────────────────
    # Go — Hardcoded Credentials
    # ────────────────────────────────────────
    "vulnix.go.crypto.hardcoded_key": {
        "vulnerability_type": "hardcoded_credentials",
        "cwe_id": "CWE-798",
        "owasp_category": "A02:2021 - Cryptographic Failures",
    },

    # ────────────────────────────────────────
    # Go — Weak Crypto
    # ────────────────────────────────────────
    "vulnix.go.crypto.weak_hash_md5": {
        "vulnerability_type": "weak_crypto",
        "cwe_id": "CWE-328",
        "owasp_category": "A02:2021 - Cryptographic Failures",
    },
}


# Semgrep severity -> Vulnix severity 초기 매핑
# (LLM이 재평가하므로 이 값은 fallback용)
SEVERITY_MAP: dict[str, str] = {
    "ERROR": "high",
    "WARNING": "medium",
    "INFO": "low",
}


def map_finding_to_vulnerability(rule_id: str, semgrep_severity: str) -> dict[str, str | None]:
    """Semgrep rule_id를 Vulnerability 모델 필드로 매핑한다.

    Args:
        rule_id: Semgrep 룰 ID
        semgrep_severity: Semgrep 심각도 (ERROR / WARNING / INFO)

    Returns:
        {"vulnerability_type", "cwe_id", "owasp_category", "severity"} 딕셔너리
    """
    mapping = RULE_MAPPING.get(rule_id, {})
    return {
        "vulnerability_type": mapping.get("vulnerability_type", "unknown"),
        "cwe_id": mapping.get("cwe_id"),
        "owasp_category": mapping.get("owasp_category"),
        "severity": SEVERITY_MAP.get(semgrep_severity, "medium"),
    }


def detect_language_from_rule_id(rule_id: str) -> str:
    """rule_id의 두 번째 세그먼트에서 언어를 추출한다.

    형식: vulnix.{language}.{category}.{rule}
    예: vulnix.javascript.injection.sql → "javascript"
        vulnix.java.xss.servlet → "java"
        vulnix.go.crypto.weak_hash → "go"
        vulnix.python.sql_injection → "python"

    세그먼트가 3개 미만이거나 vulnix 접두사가 없으면 "unknown"을 반환한다.

    Args:
        rule_id: Semgrep 룰 ID 문자열

    Returns:
        언어 이름 문자열 또는 "unknown"
    """
    parts = rule_id.split(".")
    # 최소 3개 세그먼트(vulnix.{lang}.{rest})이고 접두사가 vulnix여야 한다
    if len(parts) >= 3 and parts[0] == "vulnix":
        return parts[1]
    return "unknown"
