"""Vulnerability 모델 — 탐지된 취약점"""

import uuid
from datetime import datetime

from sqlalchemy import DateTime, ForeignKey, Integer, Numeric, String, Text
from sqlalchemy.dialects.postgresql import JSONB, UUID
from sqlalchemy.orm import Mapped, mapped_column, relationship

from src.models.base import Base, TimestampMixin, UUIDMixin


class Vulnerability(UUIDMixin, TimestampMixin, Base):
    """취약점 테이블.

    Semgrep + LLM 하이브리드 분석으로 탐지된 취약점을 저장.
    상태 관리: open -> patched / ignored / false_positive
    """

    __tablename__ = "vulnerability"
    __table_args__ = {"comment": "탐지된 취약점"}

    scan_job_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("scan_job.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
        comment="발견된 스캔 작업 ID (FK)",
    )
    repo_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("repository.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
        comment="저장소 ID (FK)",
    )

    # 취약점 상태: open / patched / ignored / false_positive
    status: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        default="open",
        index=True,
        comment="취약점 상태 (open / patched / ignored / false_positive)",
    )

    # 심각도: critical / high / medium / low
    severity: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        index=True,
        comment="심각도 (critical / high / medium / low)",
    )

    vulnerability_type: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        comment="취약점 유형 (예: sql_injection, xss, hardcoded_credentials)",
    )
    cwe_id: Mapped[str | None] = mapped_column(
        String(20),
        nullable=True,
        comment="CWE 분류 (예: CWE-89)",
    )
    owasp_category: Mapped[str | None] = mapped_column(
        String(50),
        nullable=True,
        comment="OWASP Top 10 분류",
    )

    # 코드 위치
    file_path: Mapped[str] = mapped_column(
        String(500),
        nullable=False,
        comment="취약 파일 경로",
    )
    start_line: Mapped[int] = mapped_column(
        Integer,
        nullable=False,
        comment="취약 코드 시작 라인",
    )
    end_line: Mapped[int] = mapped_column(
        Integer,
        nullable=False,
        comment="취약 코드 끝 라인",
    )
    code_snippet: Mapped[str | None] = mapped_column(
        Text,
        nullable=True,
        comment="취약 코드 조각 (전후 5줄 포함)",
    )

    # 분석 결과
    description: Mapped[str | None] = mapped_column(
        Text,
        nullable=True,
        comment="취약점 설명",
    )
    llm_reasoning: Mapped[str | None] = mapped_column(
        Text,
        nullable=True,
        comment="LLM 분석 근거",
    )
    llm_confidence: Mapped[float | None] = mapped_column(
        Numeric(3, 2),
        nullable=True,
        comment="LLM 확신도 (0.00 ~ 1.00)",
    )
    semgrep_rule_id: Mapped[str | None] = mapped_column(
        String(255),
        nullable=True,
        comment="탐지에 사용된 Semgrep 룰 ID",
    )

    # 참고 링크 (JSONB 배열)
    references: Mapped[list | None] = mapped_column(
        JSONB,
        nullable=True,
        comment="참고 링크 목록 (CVE, OWASP 등)",
    )

    detected_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
        comment="최초 탐지 시각",
    )
    resolved_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
        comment="해결 시각",
    )

    # F-03 자동 패치 PR 생성 — 패치 불가 시 수동 가이드 필드
    manual_guide: Mapped[str | None] = mapped_column(
        Text,
        nullable=True,
        comment="패치 불가 시 수동 수정 가이드 (LLM 생성)",
    )
    manual_priority: Mapped[str | None] = mapped_column(
        String(10),
        nullable=True,
        index=True,
        comment="수동 수정 우선순위 (P0=critical / P1=high / P2=medium / P3=low)",
    )

    # 관계
    scan_job: Mapped["ScanJob"] = relationship(  # noqa: F821
        "ScanJob",
        back_populates="vulnerabilities",
    )
    repository: Mapped["Repository"] = relationship(  # noqa: F821
        "Repository",
        back_populates="vulnerabilities",
    )
    patch_pr: Mapped["PatchPR | None"] = relationship(  # noqa: F821
        "PatchPR",
        back_populates="vulnerability",
        uselist=False,
    )

    def __repr__(self) -> str:
        return (
            f"<Vulnerability id={self.id} type={self.vulnerability_type} "
            f"severity={self.severity} status={self.status}>"
        )
