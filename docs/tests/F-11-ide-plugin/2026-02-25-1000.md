# F-11 IDE 플러그인 - RED 단계 테스트 결과

## 실행 정보

- **날짜**: 2026-02-25
- **단계**: Phase 1 - RED (구현 전 실패 테스트 확인)
- **실행 명령**: `cd vscode-extension && npm test`
- **프레임워크**: Jest + ts-jest

## 테스트 결과 요약

| 항목 | 결과 |
|------|------|
| 전체 테스트 스위트 | 5개 |
| FAIL | 5개 |
| PASS | 0개 |
| 테스트 케이스 수 | 0개 실행 (모듈 not found로 수집 실패) |

## 실패 이유

구현 파일이 존재하지 않으므로 모든 테스트 스위트가 `Cannot find module` 에러로 FAIL합니다.
이는 RED 단계의 정상적인 결과입니다.

## 테스트 파일 목록

### 1. `test/suite/diagnostic-mapper.test.ts`
- **실패 이유**: `Cannot find module '../../src/diagnostics/diagnostic-mapper'`
- **구현 필요 파일**: `src/diagnostics/diagnostic-mapper.ts`
- **테스트 케이스 목록**:
  - critical 심각도는 DiagnosticSeverity.Error로 매핑된다
  - high 심각도는 DiagnosticSeverity.Error로 매핑된다
  - medium 심각도는 DiagnosticSeverity.Warning으로 매핑된다
  - low 심각도는 DiagnosticSeverity.Information으로 매핑된다
  - start_line 1-base를 0-base로 변환하여 range.start.line에 설정한다
  - start_col과 end_col을 range의 character에 그대로 설정한다
  - 단일 라인 취약점의 range가 올바르게 설정된다
  - 메시지 형식이 "[Vulnix] {severity}: {message} ({cwe_id})"이다
  - critical 심각도 메시지 포맷이 올바르다
  - source는 "Vulnix"로 설정된다
  - code.value는 rule_id로 설정된다
  - code.target은 CWE URL로 설정된다
  - low 심각도 진단에는 DiagnosticTag.Unnecessary 태그가 설정된다
  - high 심각도 진단에는 DiagnosticTag.Unnecessary 태그가 없다
  - start_line이 1(최소값)이면 range.start.line은 0이다
  - start_col이 0이면 range.start.character는 0이다

### 2. `test/suite/fp-cache.test.ts`
- **실패 이유**: `Cannot find module '../../src/analyzer/fp-cache'`
- **구현 필요 파일**: `src/analyzer/fp-cache.ts`, `src/api/types.ts`
- **테스트 케이스 목록**:
  - rule_id가 정확히 일치하는 활성 패턴이 있으면 true를 반환한다
  - rule_id가 일치하지 않으면 false를 반환한다
  - rule_id가 부분 일치해도 false를 반환한다 (완전 일치만 허용)
  - "tests/**" 패턴이 "tests/conftest.py" 경로에 매칭된다
  - "tests/**" 패턴이 "tests/unit/test_api.py" 경로에 매칭된다
  - "tests/**" 패턴이 "src/api/routes.py" 경로에 매칭되지 않는다
  - "tests/fixtures/**" 패턴이 "tests/fixtures/sample.py" 경로에 매칭된다
  - "tests/fixtures/**" 패턴이 "tests/conftest.py" 경로에 매칭되지 않는다
  - is_active가 false인 패턴은 매칭에서 제외된다
  - 패턴이 없으면 항상 false를 반환한다
  - loadPatterns() 후 globalState에 패턴이 저장된다
  - 새로운 FPCache 인스턴스가 globalState에서 패턴을 복원한다

### 3. `test/suite/api-client.test.ts`
- **실패 이유**: `Cannot find module '../../src/api/client'`
- **구현 필요 파일**: `src/api/client.ts`
- **테스트 케이스 목록**:
  - 200 응답 시 findings 배열을 반환한다
  - findings가 없는 200 응답 시 빈 배열을 반환한다
  - 401 응답 시 AuthError를 던진다
  - 401 AuthError의 메시지에 인증 실패 정보가 포함된다
  - 500 응답 시 ServerError를 던진다
  - 500 ServerError의 메시지에 서버 오류 정보가 포함된다
  - 429 응답 시 RateLimitError를 던진다
  - analyze() 요청에 X-API-Key 헤더가 포함된다
  - Content-Type: application/json 헤더가 포함된다
  - 요청 메서드는 POST이다
  - 200 응답 시 패턴 목록을 반환한다
  - ETag를 If-None-Match 헤더로 전송한다

### 4. `test/suite/patch-applier.test.ts`
- **실패 이유**: `Cannot find module '../../src/code-actions/patch-applier'`
- **구현 필요 파일**: `src/code-actions/patch-applier.ts`
- **테스트 케이스 목록**:
  - 단일 라인 삭제 후 교체 diff를 TextEdit 배열로 변환한다
  - 단일 라인 교체 시 TextEdit의 range가 올바른 라인을 가리킨다
  - 단일 라인 교체 시 TextEdit의 newText가 교체 내용을 포함한다
  - 멀티 라인 교체 diff를 TextEdit 배열로 변환한다
  - 멀티 라인 diff에서 삭제된 라인의 range가 올바르게 설정된다
  - 여러 hunk가 있는 diff를 파싱하면 여러 TextEdit를 반환한다
  - 빈 diff 문자열을 전달하면 빈 배열을 반환한다
  - hunk 헤더(@@ ... @@)가 없는 diff를 전달하면 빈 배열을 반환한다
  - 1번 라인 교체 diff를 파싱하면 range.start.line이 0이다
  - 삭제만 있는 diff(추가 없음)를 파싱하면 빈 텍스트로 교체한다

### 5. `test/suite/config.test.ts`
- **실패 이유**: `Cannot find module '../../src/config'`
- **구현 필요 파일**: `src/config.ts`
- **테스트 케이스 목록**:
  - apiKey가 빈 문자열이면 false를 반환한다
  - apiKey가 undefined이면 false를 반환한다
  - apiKey와 serverUrl이 모두 설정되면 true를 반환한다
  - serverUrl이 빈 문자열이면 false를 반환한다
  - severityFilter 기본값은 "all"이다
  - "high"으로 설정된 severityFilter를 올바르게 반환한다
  - "critical"으로 설정된 severityFilter를 올바르게 반환한다
  - 설정된 serverUrl을 반환한다
  - serverUrl이 설정되지 않으면 기본값 "https://api.vulnix.dev"를 반환한다
  - 설정된 apiKey를 반환한다
  - analyzeOnSave 기본값은 true이다
  - analyzeOnSave가 false로 설정되면 false를 반환한다

## 구현 에이전트 전달 사항

다음 파일들을 구현해야 합니다:

| 구현 대상 파일 | 관련 테스트 |
|---------------|------------|
| `src/api/types.ts` | fp-cache, diagnostic-mapper |
| `src/api/client.ts` | api-client |
| `src/config.ts` | config |
| `src/analyzer/fp-cache.ts` | fp-cache |
| `src/diagnostics/diagnostic-mapper.ts` | diagnostic-mapper |
| `src/code-actions/patch-applier.ts` | patch-applier |

### 핵심 구현 규약

1. **diagnostic-mapper.ts**
   - `mapFindingToDiagnostic(finding: Finding): vscode.Diagnostic` 함수 export
   - severity: critical/high -> Error, medium -> Warning, low -> Information
   - range: `new Range(start_line - 1, start_col, end_line - 1, end_col)` (1-base -> 0-base)
   - message: `[Vulnix] ${severity}: ${message} (${cwe_id})`
   - source: `"Vulnix"`
   - code: `{ value: rule_id, target: Uri.parse(cwe_url) }`
   - low severity: `tags: [DiagnosticTag.Unnecessary]`

2. **fp-cache.ts**
   - `FalsePositivePattern` 인터페이스 export
   - `FPCache` 클래스 export (생성자: `MockMemento` 호환 스토리지 인자)
   - `loadPatterns(patterns: FalsePositivePattern[]): void` - globalState 저장 포함
   - `matchesAny(finding: Finding): boolean` - minimatch 라이브러리로 glob 매칭
   - `is_active: false` 패턴은 무시
   - 인스턴스 생성 시 globalState에서 자동 복원

3. **api/client.ts**
   - `AuthError`, `ServerError`, `RateLimitError` 커스텀 에러 클래스 export
   - `ApiClient` 클래스 export (생성자: `serverUrl: string, apiKey: string`)
   - `analyze(request): Promise<AnalyzeResponse>` - X-API-Key 헤더 포함
   - `getFalsePositivePatterns(etag?: string): Promise<FPPatternsResponse>`
   - 401 -> AuthError, 500 -> ServerError, 429 -> RateLimitError

4. **patch-applier.ts**
   - `parseDiffToEdits(diff: string): vscode.TextEdit[]` 함수 export
   - unified diff 파싱 (@@ -start,count +start,count @@ 형식)
   - 1-base 라인 번호를 0-base로 변환
   - 빈 diff 또는 hunk 없는 diff -> 빈 배열 반환

5. **config.ts**
   - `VulnixConfig` 클래스 export
   - `isConfigured(): boolean` - apiKey와 serverUrl이 모두 비어있지 않을 때 true
   - `getServerUrl(): string` - 기본값: `"https://api.vulnix.dev"`
   - `getApiKey(): string`
   - `getSeverityFilter(): 'all' | 'high' | 'critical'` - 기본값: `"all"`
   - `isAnalyzeOnSaveEnabled(): boolean` - 기본값: `true`
