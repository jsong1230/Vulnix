# Quality Gate 결과: F-05 (다국어 탐지 엔진 확장) + F-06 (오탐 관리)

**검증일**: 2026-02-25
**검증자**: quality-gate
**브랜치**: main
**검토 범위**: F-05 룰 파일 13개, F-06 백엔드 구현 전체

---

## 보안

### Critical

없음

### Warning

- **[W-01] IDOR 위험: POST /api/v1/false-positives에서 팀 admin/owner 역할 미검증**
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/false_positives.py` Line 116-139
  - 설명: 설계서(3-2절)에는 "팀 admin/owner만" 패턴 등록 가능으로 명시되어 있으나, 구현에서는 팀 소속 여부(TeamMember 존재 여부)만 확인하고 `role` 필드 검증을 수행하지 않는다. `member` 역할 사용자도 패턴을 등록할 수 있다.
  - 영향: 설계서 에러 케이스 테이블 "403 팀 admin/owner 권한 없음" 조건이 구현되지 않음.
  - 수정 방법: `TeamMember.role in ("owner", "admin")` 조건을 추가해야 한다. `create_false_positive`, `delete_false_positive`, `restore_false_positive` 세 엔드포인트 모두 해당.

- **[W-02] IDOR 위험: DELETE/PUT restore에서 타 팀 패턴 접근 차단 로직 의존성**
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/false_positives.py` Line 67-104
  - 설명: `soft_delete_fp_pattern`, `restore_fp_pattern`은 `pattern_id + team_id` 복합 조건으로 조회하여 타 팀 패턴에는 None을 반환한다. 이 자체는 안전하지만, `get_user_team_id`가 사용자의 첫 번째 팀만 반환하므로(LIMIT 1) 사용자가 여러 팀에 속한 경우 다른 팀의 패턴에 대한 요청이 404로 처리된다. 의도치 않은 정보 노출은 없으나 다중 팀 시나리오에서 기능 오동작 가능성이 있다.
  - 수정 방법: `get_user_team_id` 대신 사용자 소속 모든 팀 목록을 조회하고 `pattern.team_id IN user_team_ids` 조건으로 검증해야 한다.

- **[W-03] python-jose 알려진 취약점 (CVE-2024-33663)**
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/pyproject.toml` Line 13
  - 설명: `python-jose==3.3.0`은 ECDSA 서명 알고리즘에 대한 취약점(CVE-2024-33663)이 보고되어 있다. 현재 JWT_ALGORITHM 설정값을 확인해야 한다. HS256을 사용하는 경우 직접적인 영향은 낮지만 의존성 업데이트가 필요하다.
  - 수정 방법: `python-jose` 최신 버전으로 업데이트 또는 `PyJWT`(이미 2.10.0 설치됨)로 일원화 검토.

- **[W-04] 로그에 exception 메시지 노출 가능성**
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/workers/scan_worker.py` Line 227
  - 설명: `str(e)`를 ScanJob.error_message에 저장하고 로그에도 기록한다. DB 연결 오류 등 시스템 내부 정보가 DB에 기록될 수 있다. 현재는 API 응답에 직접 노출되지 않으므로 Low 수준이나 모니터링 경로를 통해 노출 가능성 존재.

### 통과

- JWT Bearer 인증 미들웨어가 모든 보호 API(`CurrentUser` 타입 주입)에 적용됨 (deps.py)
- JWT 검증: 만료, 서명, sub 페이로드 검증 모두 구현됨 (deps.py Line 67-85)
- 취약점 상태 변경(PATCH /vulnerabilities/{id})에서 저장소-팀 소속 검증이 올바르게 구현됨 (vulns.py Line 360-370)
- 취약점 목록 조회에서 repo_id 필터에 대한 팀 소속 검증 구현됨 (vulns.py Line 80-84)
- ORM 사용으로 SQL Injection 없음
- 시크릿 하드코딩 없음 (.env 환경변수 사용 확인)
- FPFilterService DB 조회 실패 시 fail-open 처리로 스캔 파이프라인 중단 방지 (fp_filter_service.py Line 122-127)
- Dashboard false-positive-rate 엔드포인트에 인증 필요 (CurrentUser 주입 확인)

---

## 성능

### Critical

없음

### Warning

- **[P-01] scan_worker.py에서 FPFilterService 미연동 — F-06 핵심 파이프라인 누락**
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/workers/scan_worker.py` Line 92-233
  - 설명: 설계서(7-2절, ADR-F06-004)에 따르면 Semgrep 1차 스캔 직후(step 4.5) `FPFilterService.filter_findings()`를 호출하여 오탐 패턴 자동 필터링을 수행해야 한다. 그러나 현재 `scan_worker.py`에는 `FPFilterService` import도, 호출도 존재하지 않는다. F-06 인수조건 "오탐 마킹된 패턴을 학습하여 이후 동일 패턴 자동 제외"가 실제로 동작하지 않는 상태이다.
  - 영향: F-06 인수조건 미충족. LLM 비용 절감 효과도 없음.
  - 수정 방법: `_run_scan_async` step 4와 step 5 사이에 `FPFilterService.filter_findings(findings, team_id, scan_job_id)` 호출을 삽입하고, `auto_filtered_count`를 `_update_scan_stats`에 전달해야 한다.

- **[P-02] 대용량 findings 처리 시 N+1 쿼리 잠재적 위험**
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/dashboard.py` Line 63-77
  - 설명: `_get_vulns_by_repos`는 `Vulnerability.repo_id.in_(repo_ids)`로 단일 쿼리를 수행하나, 반환된 모든 Vulnerability 객체를 Python 메모리에 로드한다. 저장소 수 x 취약점 수에 따라 수만 건 로드 가능. 현재 PoC 단계에서는 허용 가능하지만, 운영 환경에서는 집계(COUNT, SUM)를 DB에서 수행해야 한다.

- **[P-03] `get_fp_patterns_by_team`에서 is_active 필터 미적용**
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/false_positives.py` Line 56-64
  - 설명: 설계서(3-3절)에서 GET /api/v1/false-positives의 `is_active` 쿼리 파라미터(기본 true)로 필터링을 지원하도록 설계되었으나, 구현에서는 `is_active` 필터 없이 팀의 전체 패턴을 반환한다. 목록 API에 페이지네이션도 미구현.
  - 수정 방법: `is_active` 파라미터 지원 및 페이지네이션 추가 필요.

### 통과

- `FPFilterService._load_patterns`는 `is_active=True` 조건으로 활성 패턴만 조회함 (fp_filter_service.py Line 43-51)
- `idx_fp_pattern_team_active`, `idx_fp_pattern_rule_id` 인덱스가 마이그레이션에 포함됨 (003_add_f06_tables.py)
- `list_vulns_query`에서 COUNT 쿼리를 DB에서 집계하고 페이지네이션 적용됨 (vulns.py Line 99-109)
- dashboard.py `get_vulnerability_trend`에서 Vulnerability 조회 후 Python에서 집계하나 기간(최대 90일) 제한 적용됨
- LLM 분석 asyncio.Semaphore(5)로 동시성 제한 적용됨

---

## 설계/문서 일치

### 설계 불일치

- **[D-01] scan_worker.py에 FPFilterService 미연동 (설계서 5-2절, 7-2절)**
  - 설계서: Semgrep 결과 직후 FPFilterService.filter_findings() 호출 → filtered_findings를 LLM에 전달, auto_filtered_count를 ScanJob에 업데이트
  - 구현: FPFilterService 미사용, findings 전체가 LLM으로 전달됨, auto_filtered_count 항상 0
  - 영향도: F-06 핵심 기능 미동작

- **[D-02] false_positives.py GET 목록 API에 is_active 필터 및 페이지네이션 미구현 (설계서 3-3절)**
  - 설계서: `is_active`, `page`, `per_page`, `team_id` 쿼리 파라미터 지원, meta 포함 응답
  - 구현: 파라미터 없이 팀 전체 패턴 반환, meta 없음

- **[D-03] false_positives.py POST/DELETE/restore에서 admin/owner 권한 미검증 (설계서 3-2절, 3-4절, 3-5절)**
  - 설계서: "팀 admin/owner만" 명시
  - 구현: 팀 소속 여부만 확인, role 미검증

- **[D-04] FalsePositivePattern.reason 필드 설계서와 구현 불일치**
  - 설계서(4-1절): `reason TEXT NOT NULL`
  - 구현(false_positive.py Line 45-49): `nullable=True`
  - 마이그레이션(003_add_f06_tables.py Line 35): `nullable=True`
  - 영향: 오탐 패턴 등록 시 사유 누락 가능

- **[D-05] Dashboard false-positive-rate에서 top_fp_rules 미구현 (설계서 3-6절)**
  - 설계서: `top_fp_rules` 배열에 semgrep_rule_id별 오탐 빈도 상위 룰 포함
  - 구현(dashboard.py Line 332): 항상 빈 배열(`[]`) 반환

- **[D-06] FalsePositivePattern.team_id에 FK 제약 미설정 (설계서 4-1절)**
  - 설계서: `team_id UUID FK -> team.id`
  - 구현(false_positive.py Line 29-34): `ForeignKey` 없이 `index=True`만 설정
  - 마이그레이션(003_add_f06_tables.py): `ForeignKeyConstraint` 없음
  - 영향: 팀 삭제 시 고아 패턴 발생 가능, 참조 무결성 미보장

- **[D-07] FalsePositivePattern.created_by에 FK 제약 미설정 (설계서 4-1절)**
  - 설계서: `created_by UUID FK -> user.id`
  - 구현(false_positive.py Line 67-71): `ForeignKey` 없이 `nullable=True`만 설정
  - 마이그레이션: `ForeignKeyConstraint` 없음

- **[D-08] 설계서 UNIQUE 인덱스 미구현 (설계서 4-4절)**
  - 설계서: `CREATE UNIQUE INDEX idx_fp_pattern_unique ON false_positive_pattern(team_id, semgrep_rule_id, COALESCE(file_pattern, '')) WHERE is_active = true`
  - 구현(003_add_f06_tables.py): 해당 UNIQUE 인덱스 없음
  - 영향: 동일 팀에서 동일 rule_id + file_pattern 중복 패턴 생성 가능 (DB 레벨 방지 불가)
  - 코드 레벨: `vulns.py create_fp_pattern_from_vuln`에서 중복 확인 로직이 있으나 race condition 취약

- **[D-09] Java weak_crypto.yml CWE 불일치 (설계서 vs 룰 파일)**
  - `java/weak_crypto.yml` Line 12: `cwe: CWE-327`
  - `vulnerability_mapper.py` Line 192: `"cwe_id": "CWE-328"`
  - vulnerability_mapper의 vulnix.java.crypto.weak_hash는 CWE-328을 사용하지만, Semgrep 룰 파일은 CWE-327을 사용하여 불일치

### 인수조건 충족 (F-05)

- 충족: JavaScript/TypeScript 코드 대상 취약점 탐지 가능 (rules/javascript/ 5개 파일 존재)
- 충족: Java 코드 대상 취약점 탐지 가능 (rules/java/ 4개 파일 존재)
- 충족: Go 코드 대상 취약점 탐지 가능 (rules/go/ 4개 파일 존재)
- 충족: SQL Injection 탐지 (JS/Java/Go 모두 구현)
- 충족: XSS 탐지 (JS/Java 구현)
- 충족: Insecure JWT 탐지 (JS 구현)
- 충족: 암호화 취약점 (weak hash, hardcoded key) 탐지 (JS/Java/Go 구현)
- 충족: CORS 과도 허용 설정 오류 탐지 (JS 구현)
- 충족: Semgrep 룰 YAML 형식 유효성 (languages 필드, pattern/pattern-either 존재)
- 충족: detect_language_from_rule_id() 구현 (vulnerability_mapper.py Line 269-290)
- 충족: LLM 프롬프트 다국어화 (_detect_language_from_path + _build_analysis_prompt)
- 미충족: "OWASP Top 10 전체 카테고리 탐지 지원" — A01(Broken Access Control), A04(Insecure Design), A06(Vulnerable Components), A08(Software Integrity Failures), A09(Logging Failures), A10(SSRF) 룰 없음. A03(Injection), A02(Crypto), A05(Misconfig), A07(Auth)만 커버

### 인수조건 충족 (F-06)

- 충족: 개발자가 특정 취약점을 오탐으로 마킹 가능 (PATCH /vulnerabilities/{id} + create_pattern 옵션)
- 충족: 팀 단위 오탐 규칙 공유 가능 (team_id 기반 FalsePositivePattern)
- 충족: 오탐 마킹 해제(복원) 가능 (PUT /false-positives/{id}/restore)
- 충족: 오탐율 트래킹 대시보드 (GET /dashboard/false-positive-rate)
- 미충족: "오탐 마킹된 패턴을 학습하여 이후 동일 패턴 자동 제외" — scan_worker.py에서 FPFilterService 미연동으로 실제 자동 필터링이 동작하지 않음 ([P-01], [D-01])
- 미충족: "오탐 피드백이 탐지 엔진 정확도 향상에 반영됨을 확인 가능" — auto_filtered_count 항상 0으로 기록됨, FalsePositiveLog 미생성

---

## 시각 검증

- 생략: ui-spec.md 없음 (백엔드 전용 기능)

---

## 종합 판정

- FAIL: Critical 이슈 0건, High 이슈 2건 — 수정 후 재검증 필요

### 우선 수정 항목 (배포 전 필수)

1. **[P-01/D-01]** `scan_worker.py`에 `FPFilterService` 연동 — F-06 핵심 기능 미동작
2. **[W-01/D-03]** `false_positives.py` admin/owner role 권한 검증 추가
3. **[D-06]** `false_positive_pattern.team_id`에 FK 제약 추가 (마이그레이션)
4. **[D-08]** UNIQUE 인덱스 추가 (team_id + semgrep_rule_id + file_pattern)

### 차기 스프린트 수정 항목

5. **[D-02]** GET /false-positives 목록 API에 is_active 필터 및 페이지네이션 추가
6. **[D-05]** top_fp_rules 구현 (Vulnerability 테이블에서 rule_id 기준 집계)
7. **[D-09]** Java weak_crypto CWE 코드 불일치 수정 (CWE-327 vs CWE-328)
8. **[W-02]** 다중 팀 소속 사용자를 위한 team_id 조회 로직 개선
9. **[F-05]** OWASP A01/A04/A06/A08/A09/A10 카테고리 룰셋 추가 (인수조건 미충족)
