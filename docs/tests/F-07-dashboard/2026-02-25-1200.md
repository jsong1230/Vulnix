# Quality Gate 결과: F-07 대시보드 + F-08 Slack/Teams 알림

검증일: 2026-02-25
검증 브랜치: main
검증 대상: M2-B 배치 (F-07 dashboard, F-08 notifications)

---

## Quality Gate 결과: F-07 대시보드 + F-08 Slack/Teams 알림 (M2-B)

### 보안

- P-0 Critical: [Alembic 마이그레이션 분기 충돌] `004_add_f07_indexes.py`와 `004_add_f08_tables.py`가 동일한 `down_revision = "003_add_f06_tables"`를 부모로 선언하고 있어 Alembic 마이그레이션 DAG가 분기됩니다. `alembic upgrade head` 실행 시 "Multiple head revisions" 오류가 발생하여 운영 배포가 불가능합니다.
  - `backend/alembic/versions/004_add_f07_indexes.py:17`
  - `backend/alembic/versions/004_add_f08_tables.py:22`

- P-1 Critical: [_is_internal_ip IPv6 불완전 차단] `_is_internal_ip` 함수가 IPv6 루프백(`::1`)만 처리하고 `::ffff:127.0.0.1`(IPv4-mapped IPv6), `fc00::/7`(ULA), `fe80::/10`(링크 로컬) 등 IPv6 내부 주소 범위를 차단하지 않습니다. 공격자가 IPv6 주소로 SSRF 우회를 시도할 수 있습니다.
  - `backend/src/services/notification_service.py:101-145`

- P-1 Critical: [Webhook URL 응답 본문 로그 노출] `_send_webhook`에서 실패 시 `error_msg = response.text`를 그대로 NotificationLog.error_message에 저장합니다. Slack/Teams 서버가 오류 응답 본문에 토큰, 서명 정보 등 민감 데이터를 반환할 경우 DB에 평문 노출됩니다.
  - `backend/src/services/notification_service.py:322`

- W-01 Warning: [Webhook URL 평문 저장] `notification_config.webhook_url`이 DB에 평문으로 저장됩니다. Webhook URL은 사실상 비밀키에 해당하므로 AES-256 등으로 암호화 저장이 권장됩니다. 현재 설계서(F-08 설계 문서 미작성 상태)에 암호화 여부가 명시되어 있지 않습니다.
  - `backend/src/models/notification.py:42-46`

- W-02 Warning: [DNS 조회 실패 시 허용(pass)] `validate_webhook_url` 함수에서 `socket.gaierror` 발생 시 검증을 통과시킵니다. 테스트 환경 대응이 주석으로 설명되어 있으나, 프로덕션 환경에서 일시적 DNS 오류를 이용한 SSRF 우회 가능성이 있습니다. DNS 실패 시 거부하거나 별도 구성 플래그로 제어하는 것이 안전합니다.
  - `backend/src/services/notification_service.py:92-94`

- W-03 Warning: [test 엔드포인트 admin 권한 미적용] `POST /notifications/config/{config_id}/test` 엔드포인트가 팀 소속 여부만 확인하고 owner/admin 권한 검증을 생략합니다. 일반 멤버가 테스트 발송을 임의로 실행할 수 있습니다.
  - `backend/src/api/v1/notifications.py:266-351`

- W-04 Warning: [취약점 필터 입력값 enum 미검증] `GET /vulnerabilities`의 `vulnerability_type`, `status`, `severity` 파라미터가 허용 값 목록(Literal 타입)으로 제한되지 않고 문자열 그대로 SQLAlchemy WHERE 절에 전달됩니다. ORM을 사용하므로 SQL Injection 위험은 낮으나, 잘못된 값이 쿼리에 들어가 빈 결과를 반환하거나 예상치 못한 동작을 유발할 수 있습니다.
  - `backend/src/api/v1/vulns.py:94-102`

- 통과: CurrentUser 의존성으로 모든 dashboard/notifications 엔드포인트에 JWT 인증 적용됨
- 통과: IDOR 방어 — severity-distribution의 repository_id 필터가 팀 소속 저장소 목록과 교차 검증함 (`dashboard.py:642-650`)
- 통과: notifications PATCH/DELETE가 `NotificationConfig.team_id == team_id` 조건으로 IDOR 방어됨
- 통과: SSRF allowlist 방식(hooks.slack.com, webhook.office.com 등) 적용됨
- 통과: admin/owner 역할 검증이 config 생성/수정/삭제에 적용됨

### 성능

- W-05 Warning: [repo-scores / team-scores N+1 구조] `get_repo_scores`, `get_team_scores`가 `_get_repos_by_teams` → `_get_vulns_by_repos`를 순차 호출합니다. 전체 취약점을 Python 메모리로 로드한 뒤 저장소별로 분류하는 방식이므로, 취약점 수가 수만 건을 초과할 경우 메모리 및 응답 시간 문제가 발생합니다. DB 측 GROUP BY + SUM 집계 쿼리로 대체가 필요합니다.
  - `backend/src/api/v1/dashboard.py:506-537`, `568-604`

- W-06 Warning: [_aggregate_weekly_stats 미구현] `NotificationService._aggregate_weekly_stats`가 실제 DB 집계 없이 모든 통계를 0으로 반환합니다. 주간 리포트 발송 기능이 항상 "신규 취약점 0건" 메시지를 발송하게 되어 F-08 인수조건 "주간 보안 리포트 자동 발송"을 충족하지 못합니다.
  - `backend/src/services/notification_service.py:384-407`

- W-07 Warning: [send_weekly_reports asyncio.run 충돌 위험] `send_weekly_reports`가 `asyncio.run()`을 사용합니다. RQ 워커가 이미 비동기 컨텍스트 안에서 실행되는 경우 "This event loop is already running" RuntimeError가 발생합니다. RQ는 동기 함수를 별도 스레드에서 실행하므로 일반적으로는 동작하지만, aiohttp 기반 RQ 확장 사용 시 문제가 생깁니다.
  - `backend/src/workers/weekly_report_job.py:99-106`

- 통과: notification_log에 sent_at, team_id, config_id 인덱스가 모두 추가됨 (`004_add_f08_tables.py`)
- 통과: idx_vulnerability_type, idx_vulnerability_detected_at 인덱스 추가됨 (`004_add_f07_indexes.py`)
- 통과: list_vulnerabilities가 DB 측 COUNT 쿼리를 사용하여 전체 로드를 피함 (`vulns.py:107-109`)

### 설계/문서 일치

- 설계 일치: F-07 design.md의 보안 점수 공식 `max(0, 100 - (critical*25 + high*10 + medium*5 + low*1))`이 `_calc_security_score_f07`에 정확히 구현됨 (`dashboard.py:110-123`)

- 설계 일치: F-07 design.md 3-1~3-5절 API 응답 스키마(RepoScoreItem, TeamScoreItem, SeverityDistributionResponse, TrendDataPoint.open_count, DashboardSummary.avg_security_score)가 코드와 일치함

- 설계 일치: F-07 design.md 6절 인덱스 계획(idx_vulnerability_type, idx_vulnerability_detected_at) 모두 `004_add_f07_indexes.py`에 반영됨

- 문서 불일치: F-08 설계 문서(`docs/specs/F-08-*/design.md`)가 존재하지 않습니다. 구현 전 설계 문서 작성이 원칙(doc-rules)이지만 설계서 없이 구현이 진행되었습니다.

- 문서 불일치: `vulns.py:230-245`의 `_calc_security_score` 함수(가중치: critical=10, high=5, medium=2, low=1)가 F-07 설계서 공식(critical=25, high=10, medium=5, low=1)과 다릅니다. 이 함수는 `update_vulnerability_status`에서 repo.security_score 재계산에 사용되며, F-07 신규 공식 `_calc_security_score_f07`과 불일치합니다. 두 함수가 다른 결과를 낼 수 있어 보안 점수 일관성이 깨집니다.
  - `backend/src/api/v1/vulns.py:230-245` vs `backend/src/api/v1/dashboard.py:110-123`

- 인수조건 충족: F-07 — 저장소별/팀별 보안 점수 API 구현됨
- 인수조건 충족: F-07 — 취약점 추이에 open_count(미해결 누적) 포함
- 인수조건 충족: F-07 — 심각도별 분포 API 구현됨 (저장소 필터 포함)
- 인수조건 충족: F-07 — vulnerability_type 필터 추가됨
- 인수조건 충족: F-08 — Slack/Teams webhook 설정 CRUD 구현됨
- 인수조건 충족: F-08 — severity_threshold 기반 알림 필터링 구현됨
- 인수조건 미충족: F-08 — 주간 보안 리포트가 항상 0건 통계를 발송함 (`_aggregate_weekly_stats` 미구현, W-06 참조)

### 시각 검증

- 생략: ui-spec.md 없음 (백엔드 전용 배치)

---

### 종합 판정

- FAIL: Critical 이슈 3건 — 수정 후 재검증 필요

| 우선순위 | 이슈 | 파일 |
|----------|------|------|
| P-0 | Alembic 마이그레이션 브랜치 충돌 (`004_add_f07_indexes.py`, `004_add_f08_tables.py` 동일 `down_revision`) | `alembic/versions/004_add_f07_indexes.py:17`, `alembic/versions/004_add_f08_tables.py:22` |
| P-1 | _is_internal_ip IPv6 내부 주소 불완전 차단 (::ffff:127.0.0.1, fc00::/7, fe80::/10 미처리) | `src/services/notification_service.py:101-145` |
| P-1 | Webhook 오류 응답 본문 평문 DB 저장 (민감 정보 노출 위험) | `src/services/notification_service.py:322` |
| W-01 | Webhook URL 평문 DB 저장 | `src/models/notification.py:42-46` |
| W-02 | DNS 조회 실패 시 SSRF 검증 통과 | `src/services/notification_service.py:92-94` |
| W-03 | 테스트 알림 엔드포인트 admin 권한 미적용 | `src/api/v1/notifications.py:266-351` |
| W-04 | vulnerability_type/status/severity 필터 enum 미검증 | `src/api/v1/vulns.py:94-102` |
| W-05 | repo-scores/team-scores 전체 취약점 메모리 로드 (N+1 위험) | `src/api/v1/dashboard.py:506-537`, `568-604` |
| W-06 | _aggregate_weekly_stats 미구현 (주간 리포트 항상 0건) | `src/services/notification_service.py:384-407` |
| W-07 | _calc_security_score(vulns.py) vs _calc_security_score_f07(dashboard.py) 공식 불일치 | `src/api/v1/vulns.py:230-245` vs `src/api/v1/dashboard.py:110-123` |

