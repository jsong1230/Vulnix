# Quality Gate 결과: F-03 (자동 패치 PR 생성) + F-04 (스캔 결과 API 및 기본 UI)

**검증일**: 2026-02-25
**브랜치**: main
**검증 범위**: F-03 전체, F-04 전체 (백엔드 + 프론트엔드)
**테스트 실행 결과**: F-03 28 passed / F-04 30 passed (관련 테스트 기준)

---

## 보안

### Critical

- **[CRITICAL-SEC-01]** JWT 토큰 localStorage 저장
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/frontend/src/lib/api-client.ts` L36, L57-59
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/frontend/src/lib/auth.ts` L8-9, L68-70
  - 이슈: Access Token과 Refresh Token 모두 localStorage에 저장. XSS 공격 발생 시 토큰 탈취 가능. 보안 표준에서는 HttpOnly 쿠키 사용을 권장.
  - 수정 방법: Next.js middleware + HttpOnly 쿠키 기반 세션 또는 BFF(Backend for Frontend) 패턴으로 전환. 최소한 sessionStorage로도 범위 제한 효과가 있으나 근본 해결은 HttpOnly 쿠키.

- **[CRITICAL-SEC-02]** `scans.py` trigger_scan 엔드포인트 미구현 (NotImplementedError)
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/scans.py` L84
  - 이슈: `POST /api/v1/scans` 엔드포인트가 `raise NotImplementedError("TODO: 수동 스캔 트리거 구현")`로 처리됨. 실제 호출 시 500 Internal Server Error 반환. FastAPI가 500 응답에서 스택 트레이스를 노출할 수 있어 구현 상세 정보 누출 위험.
  - 수정 방법: NotImplementedError를 503 Service Unavailable로 래핑하거나, 즉시 구현 완료 필요.

### Warning

- **[WARN-SEC-03]** `deps.py` JWT 토큰 만료 시간 미검증
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/deps.py` L65-71
  - 이슈: `jwt.decode()` 호출 시 `options` 파라미터가 없어 python-jose의 기본 동작에 의존. python-jose는 기본적으로 exp를 검증하나 명시적 설정이 없어 라이브러리 버전 변경 시 보안 회귀 위험.
  - 수정 방법: `jwt.decode(..., options={"verify_exp": True})` 명시적 설정 추가.

- **[WARN-SEC-04]** `github_app.py` 인메모리 토큰 캐시 멀티프로세스 미지원
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/services/github_app.py` L18
  - 이슈: `_token_cache`가 모듈 수준 전역 딕셔너리로 선언됨. 멀티 워커 환경(gunicorn 등)에서 프로세스 간 공유가 안 되어 토큰을 중복 발급하여 rate limit에 걸릴 수 있음. 보안 측면에서는 메모리에 Installation Token 평문 저장.
  - 수정 방법: Redis 캐시로 이전 또는 asyncio 이벤트 루프 수명주기로 캐시 범위 제한.

- **[WARN-SEC-05]** 취약점 상태 변경 시 reason 필드 미기록
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/vulns.py` L293-304
  - 이슈: `VulnerabilityStatusUpdateRequest.reason` 필드를 받지만 DB에 저장하지 않음. 오탐 마킹 감사 로그가 사라져 보안 감사 추적 불가.
  - 수정 방법: Vulnerability 모델에 `status_reason` 컬럼 추가 및 저장.

- **[WARN-SEC-06]** `vulns.py` list_vulnerabilities repo_id 필터 미인증 우회 가능성
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/vulns.py` L75-77
  - 이슈: `repo_id_filter`가 지정될 경우 팀 소속 저장소 목록(`repo_ids`)을 건너뛰고 직접 해당 repo의 취약점 조회. 현재 코드 흐름에서 `repo_id_filter`가 있으면 팀 소속 여부 검증 없이 쿼리 실행됨.
  - 수정 방법: `repo_id_filter`가 지정되면 해당 repo_id가 팀 소속인지 별도 검증 추가.

### 통과

- JWT Bearer 인증이 모든 보호 API에 적용 (CurrentUser 의존성 주입 패턴 일관)
- SQL Injection 없음 (SQLAlchemy ORM 사용, raw query 없음)
- .env가 .gitignore에 포함, .env.example 별도 제공
- 하드코딩된 시크릿 없음 (pydantic-settings 기반 환경변수 관리)
- CORS는 설정 기반 화이트리스트 (CORS_ORIGINS 환경변수로 제어)
- XSS 위험: dangerouslySetInnerHTML 미사용. 코드 뷰어는 순수 텍스트 렌더링

---

## 성능

### Critical

없음.

### Warning

- **[WARN-PERF-01]** `vulns.py` list_vulns_query N+1 패턴 — 전체 결과 로딩 후 Python에서 count
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/vulns.py` L91-100
  - 이슈: 페이지네이션 처리 시 `query`를 두 번 실행하는 구조. 첫 번째(L92-93)는 `count_result`를 얻기 위해 전체 결과를 로드하고 `list(all_items)`로 메모리에 올린 뒤 `len()`으로 세는 방식. 취약점 수백-수천 건 시 메모리 및 쿼리 낭비.
  - 수정 방법: `select(func.count()).select_from(base_query.subquery())`로 DB에서 COUNT 계산.

- **[WARN-PERF-02]** `dashboard.py` Redis 캐시 미구현 (ADR-F04-002 미충족)
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/dashboard.py` L185-200
  - 이슈: 설계서 ADR-F04-002에서 "Redis 캐시 TTL 5분" 결정이 있고 주석으로 "ADR-F04-002: Redis 캐시 TTL 5분 (PoC에서는 DB 직접 조회)"라고 되어 있으나, 취약점-저장소 목록을 매 요청마다 전체 로드하는 방식. 팀에 취약점이 증가하면 대시보드 로딩이 선형적으로 느려짐.
  - 수정 방법: Redis 캐시 구현. 캐시 미스 시 DB 조회 후 5분 TTL로 저장. 취약점 상태 변경 시 무효화.

- **[WARN-PERF-03]** `dashboard.py _get_vulns_by_repos()` 인덱스 미활용 가능성
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/dashboard.py` L66-76
  - 이슈: `Vulnerability.repo_id.in_(repo_ids)` 쿼리가 N개 repo_id 목록으로 IN 절 사용. 설계서 인덱스 `idx_vulnerability_repo_status` (복합: repo_id + status)는 있으나, status 조건 없이 repo_id만으로 조회하면 인덱스 선택이 옵티마이저에 달림.
  - 수정 방법: 큰 문제는 아니나 Redis 캐시와 함께 해결됨.

### 통과

- 패치 PR 생성: `asyncio.Semaphore(3)` 동시성 제한으로 GitHub API rate limit 방어 (L117)
- 취약점 목록/패치 목록: `OFFSET/LIMIT` 페이지네이션 구현 완료
- 스캔 폴링: `refetchInterval` 기반 2초 폴링, 완료 시 자동 중단

---

## 설계/문서 일치

### 설계 불일치

- **[DESIGN-01]** `patch_generator.py` base_sha 조회 위치가 설계서 흐름과 다름
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/services/patch_generator.py` L110-114
  - 설계서 4-1절 흐름: 각 patchable_result 순회 내 [3-2]에서 base_sha 조회. 구현: 모든 PR에 공통으로 사용하도록 순회 전에 1회만 조회.
  - 평가: 구현이 오히려 더 효율적(API 호출 최소화). 설계서 의도를 더 잘 달성하는 변경이므로 문제 없음. 다만 설계서에 반영 필요.

- **[DESIGN-02]** `patches.py` get_patch 엔드포인트 DB 쿼리 순서 설계서와 반대
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/patches.py` L116-133
  - 설계서 8-3절: PatchPR 조회 후 팀 소속 확인. 구현: 팀 소속 repo_id 조회 먼저, 그 다음 PatchPR 조회. 팀 소속 여부와 무관하게 PatchPR 존재 여부를 먼저 확인하지 않아 팀 소속이 없는 사용자는 404/403 둘 다 받을 수 있어 순서가 설계와 반대.
  - 수정 방법: 설계서대로 PatchPR 먼저 조회 후 404 확인, 그 다음 팀 소속 여부로 403 확인. (현재 구현도 보안 결과는 동일하나 UX에서 404가 먼저 나와야 할 케이스에 403이 나올 수 있음.)

- **[DESIGN-03]** F-04 설계서 9-2절 `verify_repo_access` 공통 헬퍼 미구현
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/deps.py`
  - 설계서 9-2절: `verify_repo_access()` 헬퍼를 `deps.py`에 추가하여 scans.py, vulns.py, dashboard.py에서 공통 사용. 구현: 각 파일에 중복된 헬퍼 함수 개별 구현(get_user_team_ids, check_team_member 등이 scans.py와 vulns.py에 각각 존재).
  - 수정 방법: 설계서대로 deps.py에 공통 헬퍼 추출.

- **[DESIGN-04]** `github_app.py` 중복 `_build_pr_body` 메서드 존재
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/services/github_app.py` L500-521
  - 이슈: `GitHubAppService` 클래스에 `_build_pr_body()` 메서드(L500)가 여전히 존재. F-03 이전 버전의 메서드로 설계서 3-1절에서 이 메서드는 `PatchGenerator._build_pr_body()`로 이전되었어야 함. 데드 코드.
  - 수정 방법: `GitHubAppService._build_pr_body()` 삭제.

### 문서 불일치

- **[DOC-01]** F-04 설계서 4-5절 Redis 캐싱 구현 누락 (설계서와 코드 불일치)
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/dashboard.py` L185
  - 설계서: Redis 캐시 키 `dashboard:summary:{team_id_hash}` TTL 5분 구현 명시. 구현: DB 직접 조회만 구현, Redis 미사용. 주석에 "(PoC에서는 DB 직접 조회)"로 의도는 설명되어 있으나, 설계서에는 이 예외가 명시되지 않음.
  - 수정 방법: 설계서에 PoC 예외 명시 또는 Redis 캐시 구현.

- **[DOC-02]** `scan-api.ts` `getVulnerabilities()` 응답 타입 캐스팅이 불안전
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/frontend/src/lib/scan-api.ts` L383-402
  - 이슈: 백엔드 `PaginatedResponse`는 `data` 필드에 배열을 직접 담으나, 프론트엔드는 `ApiResponse<RawVulnerabilitySummary[]>`로 타입 지정. `meta` 접근 시 `unknown` 경유 캐스팅(L393) 필요. 설계서 응답 형식과 구현 간 타입 불일치.
  - 수정 방법: 별도 `PaginatedApiResponse<T>` 타입 정의 후 일관 적용.

### 인수조건 충족

**F-03 인수조건:**
- 탐지된 취약점별 LLM 패치 코드 자동 생성: 충족 (generate_patch_prs 구현)
- 기존 코드 스타일/네이밍 컨벤션 유지: 충족 (_apply_unified_diff로 원본 파일 직접 수정)
- 패치 PR에 변경 코드 diff 포함: 충족 (_build_pr_body 내 diff 섹션)
- 패치 PR에 취약점 설명 (왜 위험한가) 포함: 충족 (reasoning 섹션)
- 패치 PR에 패치 설명 (무엇을 어떻게 고쳤는가) 포함: 충족
- 패치 PR에 참고 링크 (CVE, OWASP) 포함: 충족
- 패치 PR에 테스트 코드 제안 포함 (선택적): 충족 (test_suggestion 필드)
- 패치 불가능한 경우 수동 수정 가이드 + 우선순위 제공: 충족 (manual_guide, manual_priority)
- 취약점 1건당 패치 PR 생성 30초 이내: 충족 (병렬 처리, LLM 호출 없음)
- 패치 PR 승인율 40% 이상 가능한 구조: 부분 충족 (PR 본문 구성 완료, 실제 승인율은 운영 데이터 필요)

**F-04 인수조건:**
- 스캔 결과 목록 조회 REST API 제공: 부분 충족 (GET /scans/{scan_id} 구현, 목록 API 미구현)
- 취약점 상세 정보 조회 API 제공: 충족
- 저장소별 스캔 히스토리 조회 API 제공: 미구현 (repos.py list_repo_scans 미확인)
- 웹 UI에서 취약점 목록 확인 가능: 충족
- 웹 UI에서 취약점 상세 (코드 위치, 설명, 패치 PR 링크) 확인 가능: 충족
- 웹 UI에서 수동 스캔 트리거 버튼 동작: 미충족 (trigger_scan NotImplementedError)

### 인수조건 미충족

- **[AC-FAIL-01]** F-04: 수동 스캔 트리거 버튼 동작 — `POST /api/v1/scans` NotImplementedError로 500 반환
- **[AC-FAIL-02]** F-04: 스캔 결과 목록 조회 API — 단건 조회만 구현, 스캔 목록 API 없음 (설계서 4-6절 `GET /api/v1/repos/{repo_id}/scans` 구현 여부 미확인)

---

## 코드 품질

### Warning

- **[QUALITY-01]** `vulns.py` 광범위한 예외 catch — 빈 결과 반환
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/vulns.py` L39, L48
  - 이슈: `get_user_team_ids()`, `get_repo_ids_by_teams()` 내 `except Exception: return []` 패턴. DB 연결 오류, 권한 오류 등 심각한 예외도 빈 결과로 무시하여 사용자가 취약점이 0건인 것처럼 보임.
  - 수정 방법: 구체적 예외(sqlalchemy.exc.OperationalError 등)만 처리하고 나머지는 재발생.

- **[QUALITY-02]** `dashboard.py` 동일한 광범위한 예외 catch 패턴
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/dashboard.py` L38-42, L51-58
  - 이슈: QUALITY-01과 동일한 패턴. DB 오류가 빈 대시보드로 조용히 묻힘.

- **[QUALITY-03]** `StatusActions` 컴포넌트 `window.confirm` 사용
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/frontend/src/components/vulnerability/status-actions.tsx` L26
  - 이슈: window.confirm은 브라우저 기본 다이얼로그로 UX가 좋지 않고, React Testing 환경에서 mock이 필요해 테스트 작성이 어려움.
  - 수정 방법: 커스텀 확인 다이얼로그 컴포넌트로 교체.

- **[QUALITY-04]** 기존 테스트 1건 FAIL — test_parse_analysis_response_invalid_json_raises
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/tests/services/test_llm_agent.py` L449
  - 이슈: LLM 에이전트 JSON 파싱 로직이 JSONDecodeError를 raise하지 않고 경고 로그 후 빈 결과 반환으로 처리되어 테스트와 구현이 불일치. F-02 범위이나 F-03에 영향 있음 (패치 생성 파이프라인에 LLM 응답 파싱 포함).

- **[QUALITY-05]** `vulns.py` list_vulnerabilities 파라미터에 Query() 어노테이션 없음
  - 파일: `/Users/jsong/dev/jsong1230-github/Vulnix/backend/src/api/v1/vulns.py` L166-174
  - 이슈: `page`, `per_page`, `status`, `severity`, `repo_id` 파라미터에 `Query()` 어노테이션이 없어 FastAPI의 파라미터 범위 검증(ge=1, le=100 등)이 적용되지 않음. `patches.py`는 `Query(ge=1)` 등을 사용하여 일관성 없음.
  - 수정 방법: `Query(default=1, ge=1)`, `Query(default=20, ge=1, le=100)` 등 추가.

---

## 시각 검증

개발 서버 미실행으로 시각 검증 생략 (curl http://localhost:8000/health 응답 없음).

---

## 종합 판정

FAIL: Critical 이슈 2건 수정 후 재검증 필요

| 이슈 ID | 분류 | 설명 | 담당 |
|---------|------|------|------|
| CRITICAL-SEC-01 | 보안 Critical | JWT localStorage 저장 (XSS 취약) | frontend-dev |
| CRITICAL-SEC-02 | 보안 Critical | trigger_scan NotImplementedError — F-04 인수조건 미충족 + 500 에러 노출 | backend-dev |
| WARN-SEC-06 | 보안 Warning | repo_id 필터 시 팀 소속 검증 우회 | backend-dev |
| WARN-PERF-01 | 성능 Warning | list_vulns_query 전체 로드 후 Python count | backend-dev |
| AC-FAIL-01 | 인수조건 미충족 | 수동 스캔 트리거 동작 안 함 | backend-dev |
| DESIGN-04 | 설계 불일치 | GitHubAppService 데드 코드 _build_pr_body | backend-dev |
| QUALITY-04 | 코드 품질 | test_parse_analysis_response_invalid_json_raises FAIL | backend-dev |

