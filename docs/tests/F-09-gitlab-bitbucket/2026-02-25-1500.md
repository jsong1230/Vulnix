# Quality Gate 결과: F-09 GitLab/Bitbucket 연동 + F-10 CISO 리포트 (M3-A)

## 검증 메타데이터

- 날짜: 2026-02-25 15:00
- 검증 대상: F-09 GitLab/Bitbucket 연동, F-10 CISO 리포트 및 인증 증적
- 브랜치: main
- 검증자: quality-gate

---

## 보안

### Critical (P-0)

**P-0-1: PAT / App Password 평문 DB 저장**

- 파일: `backend/src/services/platform_factory.py:43-56`
- 내용: `_decrypt_token()` 함수가 평문 그대로 반환한다. 컬럼명은 `platform_access_token_enc`(AES-256 암호화 의도)이나, 실제로는 `repos_gitlab.py:67`에서 `request.access_token`을 그대로 `platform_access_token_enc`에 저장하고, `platform_factory.py`는 복호화 없이 평문 반환한다.
- 영향: DB 탈취 시 GitLab PAT(전체 저장소 read/write), Bitbucket App Password 노출
- 설계서 요구: `docs/specs/F-09-gitlab-bitbucket/design.md#5` — "AES-256 암호화하여 DB에 저장"

**P-0-2: Self-managed GitLab base_url SSRF 무방어**

- 파일: `backend/src/api/v1/repos_gitlab.py:102-133`
- 내용: `gitlab_url` 파라미터(쿼리스트링 및 요청 바디)에 대한 URL scheme/host 검증이 전혀 없다. `http://169.254.169.254/latest/meta-data/` 등 internal 주소 입력 시 GitLabPlatformService가 해당 주소로 HTTP 요청을 발송하고 응답을 그대로 처리한다.
- `gitlab_service.py:37`: `self._api_base = f"{self.base_url}/api/v4"` — base_url에 임의 값 삽입 가능
- 영향: 클라우드 메타데이터 서비스 접근, 내부 네트워크 스캐닝

### Warning (W)

**W-1: Webhook 시크릿 하드코딩된 기본값**

- 파일: `backend/src/api/v1/webhooks_gitlab.py:18`, `webhooks_bitbucket.py:19-21`
- 내용: 환경변수 미설정 시 `"test_gitlab_webhook_secret"`, `"test_bitbucket_webhook_secret"`으로 폴백한다.
- 영향: 환경변수를 설정하지 않은 스테이징/프로덕션 환경에서 임의 Webhook 요청 허용 가능
- 권고: 환경변수 미설정 시 서버 기동 실패(ValueError) 처리 필요

**W-2: Git clone 명령에 access_token이 프로세스 인자로 노출**

- 파일: `backend/src/services/gitlab_service.py:130-136`
- 내용: `subprocess.run(["git", "clone", ..., clone_url, ...])` — clone_url에 `oauth2:{token}@` 형식이 포함된다. `ps aux` 또는 `/proc/{pid}/cmdline`에서 토큰 노출 가능
- `bitbucket_service.py:114-123`도 동일 패턴
- 권고: `GIT_ASKPASS` 또는 `git credential store` 활용, 또는 `capture_output=True` 외 env 변수 주입 방식 사용

**W-3: 이메일 수신자 헤더 인젝션 미방어**

- 파일: `backend/src/services/email_service.py:71`
- 내용: `msg["To"] = ", ".join(recipients)` — recipients 각 항목에 `\r\n` 개행 문자가 포함되면 SMTP 헤더를 추가 삽입할 수 있다. Pydantic `EmailStr`로 형식 검증은 되나, MIMEText는 `\r\n` 포함 문자열을 그대로 헤더에 설정한다.
- 영향: 스팸 릴레이, 수신자 외 주소로 발송 가능
- 권고: 각 주소에서 `\r`, `\n` 제거 후 헤더 설정

**W-4: IDOR — 리포트 다운로드 시 team_id 검사 순서 취약**

- 파일: `backend/src/api/v1/reports.py:322-337`
- 내용: `team_id = await _get_user_team_id(...)` 후 `history.team_id != team_id`를 비교하는 구조는 정상이나, `team_id is None` 조건에서 동일하게 404 반환하므로 팀에 속하지 않은 사용자가 리포트 존재 여부는 404로 알 수 없다 — 이 부분은 정상. 다만 `list_report_history`(GET /history)는 `team_id is None`이면 빈 배열을 반환하여 팀 없는 사용자가 생성한 리포트는 어떤 팀도 조회하지 못하는 데이터 고아 가능성이 있다. (낮은 심각도)

---

## 성능

### Critical (P-0)

없음.

### Warning (W)

**W-5: httpx.AsyncClient 연결당 매번 새 세션 생성**

- 파일: `backend/src/services/gitlab_service.py` — `async with httpx.AsyncClient() as client:` 패턴이 10회 반복
- `backend/src/services/bitbucket_service.py` — 동일 패턴 9회
- 내용: 각 메서드 호출마다 TCP 연결 및 TLS handshake를 새로 수행한다. 클론 + 파일조회 + MR생성 등 순차 호출 시 불필요한 연결 비용 발생
- 설계서: `docs/specs/F-09-gitlab-bitbucket/design.md#11` — "httpx retry 3회" 언급만 있고 세션 재사용 명시 없음 (설계 누락)
- 권고: `__init__`에서 `self._client = httpx.AsyncClient(...)` 초기화 후 재사용, `aclose()` 처리

**W-6: PDF 렌더링 동기 호출이 async 이벤트 루프를 블로킹**

- 파일: `backend/src/services/report_service.py:274-276`
- 내용: `renderer.render_pdf(data, file_path)` 호출은 동기 함수(`reportlab.doc.build()`)이나, `generate_report()`가 `async def`로 정의된 코루틴 내에서 직접 호출된다. reportlab의 `doc.build()`는 CPU 집약적 동기 작업으로 이벤트 루프를 블로킹한다.
- 설계서: `docs/specs/F-10-ciso-report/design.md#10` — "PDF 생성은 CPU 집약적이므로 RQ 워커에서 비동기 처리" — 설계서 의도는 RQ 워커(별도 프로세스)에서 실행이나, `generate_report()`가 API 핸들러에서 직접 호출될 경우 블로킹 발생
- 권고: `asyncio.get_event_loop().run_in_executor(None, renderer.render_pdf, data, file_path)` 또는 RQ 워커에서만 호출 보장

**W-7: report_scheduler의 period_start/period_end가 항상 오늘 날짜**

- 파일: `backend/src/workers/report_scheduler.py:89-90`
- 내용: 스케줄러가 report_history를 생성할 때 `period_start=now.date()`, `period_end=now.date()`로 고정한다. 월간/분기 리포트의 경우 전월/전분기 기간이 대상이어야 하나, 현재 날짜만 기록된다.
- 영향: 자동 생성 리포트의 기간 데이터가 무의미 (당일 단일 날짜로 집계)

---

## 설계/문서 일치

### 설계 불일치

**D-1: platform_factory.py — `_decrypt_token` 미구현 (설계서 AES-256 요구)**

- 설계서: `design.md#5` 및 `#9` — "AES-256 암호화하여 DB에 저장 (기존 access_token_enc 패턴 답습)"
- 구현: `platform_factory.py:46` — "PoC 단계에서는 평문 저장. 실제 운영에서는 AES-256 복호화 구현 필요." 주석만 있고 암호화/복호화 없음. (P-0-1과 연계)

**D-2: design.md에 명시된 `idx_report_config_next_gen` partial index 마이그레이션 누락**

- 설계서: `docs/specs/F-10-ciso-report/design.md#3` — `CREATE INDEX idx_report_config_next_gen ON report_config(next_generation_at) WHERE is_active = TRUE;`
- 구현: `006_add_f10_tables.py` — 해당 인덱스 없음. `idx_report_config_team_active(team_id, is_active)` 인덱스는 있으나 `next_generation_at` 스캔 최적화 용도 인덱스는 누락
- 영향: 스케줄러가 매 분 `next_generation_at <= now AND is_active = TRUE` 조건으로 full scan 수행

**D-3: design.md에 명시된 `idx_report_history_config`, `idx_report_history_type_period` 인덱스 누락**

- 설계서: `design.md#3` — `idx_report_history_config ON report_history(config_id)`, `idx_report_history_type_period ON report_history(report_type, period_start, period_end)`
- 구현: `006_add_f10_tables.py` — 두 인덱스 모두 생성되지 않음

**D-4: report_history.config_id가 설계서에서 NOT NULL이나 구현에서 nullable**

- 설계서: `design.md#3-2` — `config_id: UUID, FK -> report_config, NOT NULL, INDEX`
- 구현: `report_history.py:28-34` — `nullable=True`, `006_add_f10_tables.py:149-152` — `nullable=True`
- 주석: 구현은 "수동 생성 시 NULL" 허용을 의도하며, 이는 실제 요구사항에 맞으나 설계서와 불일치

**D-5: calculate_next_generation 구현 로직이 설계서 의사코드와 다름**

- 설계서: `design.md#6-4` — monthly: `next_month = current.replace(day=1) + timedelta(days=32)`, quarterly: `((current.month - 1) // 3 + 1) * 3 + 1`
- 구현: `report_scheduler.py:27-43` — monthly: `month + 1` 직접 계산 방식, quarterly: `current_quarter_start = ((current.month - 1) // 3) * 3 + 1`
- 결과 검증: 구현 방식도 올바른 결과를 산출함. monthly의 경우 `current.replace(day=1) + timedelta(days=32)` 방식과 `month+1` 방식 모두 다음달 1일 00:00 UTC 반환. quarterly 로직도 동일 결과. 기능적으로는 일치하나 설계서와 코드 표현이 달라 추후 유지보수 혼란 가능성.

### 마이그레이션 체인 검증

- 005 down_revision: `"004_add_f08_tables"` — 정상
- 006 down_revision: `"005_add_f09_platform_columns"` — 정상
- 마이그레이션 체인 완전성: 통과

### 인수조건 충족

**F-09 인수조건:**

- 충족: GitLab Integration으로 저장소 연동 가능 (`repos_gitlab.py` 구현)
- 충족: Bitbucket App으로 저장소 연동 가능 (`repos_bitbucket.py` 구현)
- 충족: GitLab Merge Request 이벤트 기반 자동 스캔 (`webhooks_gitlab.py`)
- 충족: Bitbucket Pull Request 이벤트 기반 자동 스캔 (`webhooks_bitbucket.py`)
- 미충족: PAT/App Password 암호화 저장 (설계서 요구사항이나 PoC 평문 저장)

**F-10 인수조건:**

- 충족: CISO용 경영진 리포트 PDF 자동 생성 (`CISOReportRenderer`)
- 충족: 리포트에 보안 점수 추이, 취약점 통계, 대응 현황 포함
- 충족: CSAP 인증 대응용 증적 자료 포맷 출력 (`CSAPReportRenderer`)
- 충족: ISO 27001 인증 대응용 증적 자료 포맷 출력 (`ISO27001ReportRenderer`)
- 충족: ISMS 인증 대응용 증적 자료 포맷 출력 (`ISMSReportRenderer`)
- 충족: 리포트 생성 주기 설정 가능 (weekly/monthly/quarterly)
- 부분 충족: 리포트 자동 이메일 발송 가능 (EmailService 구현됨, 스케줄러 period 버그 존재)

---

## 시각 검증

생략: ui-spec.md 없음 (백엔드 전용 기능)

---

## 종합 판정

FAIL: Critical 이슈 2건 수정 후 재검증 필요

| 우선순위 | 항목 | 파일 |
|----------|------|------|
| P-0 | PAT/App Password 평문 DB 저장 | platform_factory.py:43-56, repos_gitlab.py:67, repos_bitbucket.py:69 |
| P-0 | Self-managed GitLab base_url SSRF 무방어 | repos_gitlab.py:102, gitlab_service.py:37 |
| W | Webhook 시크릿 하드코딩 기본값 | webhooks_gitlab.py:18, webhooks_bitbucket.py:19-21 |
| W | clone_url에 access_token 프로세스 인자 노출 | gitlab_service.py:130, bitbucket_service.py:114 |
| W | 이메일 헤더 인젝션 미방어 | email_service.py:71 |
| W | httpx 세션 재사용 없음 | gitlab_service.py, bitbucket_service.py |
| W | PDF 렌더링 이벤트 루프 블로킹 | report_service.py:274 |
| W | 스케줄러 period_start/end 오류 | report_scheduler.py:89-90 |
| D | idx_report_config_next_gen 인덱스 누락 | 006_add_f10_tables.py |
| D | idx_report_history_config 등 인덱스 2개 누락 | 006_add_f10_tables.py |
