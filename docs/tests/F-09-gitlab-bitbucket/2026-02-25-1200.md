# F-09 GitLab/Bitbucket 연동 — RED 단계 테스트 결과

## 실행 정보

- 날짜: 2026-02-25
- 단계: Phase 1 RED (구현 전)
- 실행 명령: `python -m pytest tests/services/test_gitlab_service.py tests/services/test_bitbucket_service.py tests/api/test_platform_webhook_api.py tests/api/test_platform_repos_api.py -v`

## 결과 요약

| 구분 | 수량 |
|------|------|
| 전체 테스트 | 59 |
| FAILED | 35 |
| ERROR (구현 모듈 없음) | 24 |
| PASSED | 0 |

RED 단계 조건 충족: 59개 전부 FAIL/ERROR

## 오류 원인

### ModuleNotFoundError (서비스 단위 테스트 — 24건)

구현 모듈이 아직 생성되지 않아 import 시 오류 발생:

- `src.services.gitlab_service` — `GitLabPlatformService` 미구현
- `src.services.bitbucket_service` — `BitbucketPlatformService` 미구현

### ImportError / 404 (API 테스트 — 35건)

구현 엔드포인트가 등록되지 않아 404 반환 또는 import 실패:

- `src.api.v1.webhooks_gitlab` — GitLab Webhook 엔드포인트 미구현
- `src.api.v1.webhooks_bitbucket` — Bitbucket Webhook 엔드포인트 미구현
- `src.api.v1.repos_gitlab` — GitLab 저장소 연동 엔드포인트 미구현
- `src.api.v1.repos_bitbucket` — Bitbucket 저장소 연동 엔드포인트 미구현

## 작성된 테스트 파일

### 1. `backend/tests/services/test_gitlab_service.py` (13개 테스트)

| 테스트 ID | 함수명 | 인수조건 |
|-----------|--------|---------|
| U-0905 | `test_gitlab_validate_credentials_valid_pat` | PAT 유효 → True |
| U-0906 | `test_gitlab_validate_credentials_invalid_pat` | PAT 무효 → False |
| U-0907 | `test_gitlab_list_repositories_success` | 저장소 목록 조회 |
| U-0908 | `test_gitlab_list_repositories_pagination` | 페이지네이션 25건 |
| U-0909 | `test_gitlab_get_changed_files_success` | MR 변경 파일 조회 |
| U-0910 | `test_gitlab_create_merge_request_success` | MR 생성 성공 |
| U-0911 | `test_gitlab_create_merge_request_api_error` | 422 오류 시 예외 |
| U-0912 | `test_gitlab_register_webhook_success` | Webhook 등록 |
| U-0913 | `test_gitlab_get_file_content_success` | base64 파일 조회 |
| U-0914 | `test_gitlab_create_branch_success` | 브랜치 생성 |
| U-0915 | `test_gitlab_create_file_commit_success` | 파일 커밋 |
| 경계 | `test_gitlab_service_strips_trailing_slash_from_base_url` | URL 정규화 |
| 경계 | `test_gitlab_get_changed_files_repo_not_found` | 404 처리 |

### 2. `backend/tests/services/test_bitbucket_service.py` (12개 테스트)

| 테스트 ID | 함수명 | 인수조건 |
|-----------|--------|---------|
| U-0917 | `test_bitbucket_validate_credentials_valid` | App Password 유효 → True |
| U-0918 | `test_bitbucket_validate_credentials_invalid` | App Password 무효 → False |
| U-0919 | `test_bitbucket_list_repositories_success` | 저장소 목록 조회 |
| U-0920 | `test_bitbucket_list_repositories_pagination` | next URL 페이지네이션 |
| U-0921 | `test_bitbucket_get_changed_files_success` | PR diffstat 조회 |
| U-0922 | `test_bitbucket_create_merge_request_success` | PR 생성 성공 |
| 에러 | `test_bitbucket_create_merge_request_unauthorized` | 401 예외 |
| 에러 | `test_bitbucket_create_merge_request_repo_not_found` | 404 예외 |
| U-0923 | `test_bitbucket_register_webhook_success` | Webhook 등록 |
| U-0924 | `test_bitbucket_create_branch_success` | 브랜치 생성 |
| U-0925 | `test_bitbucket_create_file_commit_form_data` | form-data 커밋 |
| 경계 | `test_bitbucket_list_repositories_workspace_url_encoding` | 특수문자 URL 인코딩 |

### 3. `backend/tests/api/test_platform_webhook_api.py` (19개 테스트)

| 테스트 ID | 함수명 | 인수조건 |
|-----------|--------|---------|
| U-0926 | `test_verify_gitlab_token_valid` | 유효 토큰 → True |
| U-0927 | `test_verify_gitlab_token_mismatch` | 불일치 → False |
| U-0928 | `test_verify_gitlab_token_header_none` | None → False |
| U-0929 | `test_verify_gitlab_token_uses_constant_time_comparison` | hmac.compare_digest 사용 |
| U-0930 | `test_verify_bitbucket_signature_valid` | 유효 HMAC → True |
| U-0931 | `test_verify_bitbucket_signature_invalid` | 불일치 → False |
| U-0932 | `test_verify_bitbucket_signature_header_none` | None → False |
| I-0907 | `test_gitlab_webhook_push_triggers_scan` | Push Hook → 202, scan_job_id |
| I-0908 | `test_gitlab_webhook_mr_open_triggers_scan` | MR Hook (open) → 202, scan_job_id |
| I-0909 | `test_gitlab_webhook_invalid_token_returns_403` | 잘못된 토큰 → 403 |
| - | `test_gitlab_webhook_missing_token_returns_403` | 토큰 없음 → 403 |
| - | `test_gitlab_webhook_missing_event_header_returns_400` | 이벤트 헤더 없음 → 400 |
| I-0910 | `test_bitbucket_webhook_push_triggers_scan` | repo:push → 202, scan_job_id |
| I-0911 | `test_bitbucket_webhook_pr_created_triggers_scan` | pullrequest:created → 202 |
| I-0912 | `test_bitbucket_webhook_invalid_signature_returns_403` | 잘못된 서명 → 403 |
| - | `test_bitbucket_webhook_missing_signature_returns_403` | 서명 없음 → 403 |
| - | `test_bitbucket_webhook_missing_event_key_returns_400` | 이벤트 키 없음 → 400 |
| 경계 | `test_gitlab_webhook_unknown_event_returns_200` | 미지원 이벤트 → 200 무시 |
| 경계 | `test_bitbucket_webhook_unknown_event_returns_200` | 미지원 이벤트 → 200 무시 |

### 4. `backend/tests/api/test_platform_repos_api.py` (15개 테스트)

| 테스트 ID | 함수명 | 인수조건 |
|-----------|--------|---------|
| I-0902 | `test_gitlab_register_repo_success` | GitLab 연동 성공 → 201 |
| I-0903 | `test_gitlab_register_repo_duplicate_returns_409` | 중복 → 409 |
| - | `test_gitlab_register_repo_invalid_pat_returns_422` | PAT 오류 → 422 |
| - | `test_gitlab_register_repo_unauthenticated_returns_401` | 미인증 → 401 |
| I-0901 | `test_gitlab_list_projects_success` | 프로젝트 목록, already_connected |
| - | `test_gitlab_list_projects_unauthenticated_returns_401` | 미인증 → 401 |
| I-0905 | `test_bitbucket_register_repo_success` | Bitbucket 연동 성공 → 201 |
| I-0906 | `test_bitbucket_register_repo_invalid_credentials_returns_422` | 자격증명 오류 → 422 |
| - | `test_bitbucket_register_repo_duplicate_returns_409` | 중복 → 409 |
| - | `test_bitbucket_register_repo_unauthenticated_returns_401` | 미인증 → 401 |
| I-0904 | `test_bitbucket_list_repositories_success` | Bitbucket 저장소 목록 → 200 |
| - | `test_bitbucket_list_repositories_unauthenticated_returns_401` | 미인증 → 401 |
| I-0918 | `test_list_repos_with_platform_filter_gitlab` | platform=gitlab 필터 |
| I-0917 | `test_list_repos_without_platform_filter_returns_all` | platform 필드 포함 확인 |
| I-0915 | `test_gitlab_register_repo_registers_webhook` | 연동 시 Webhook 자동 등록 |

## 구현 에이전트 요청 사항

backend-dev 에이전트에게 다음 파일 구현을 요청합니다:

### 신규 생성 필요

1. `backend/src/services/gitlab_service.py` — `GitLabPlatformService` (PAT + REST API v4)
2. `backend/src/services/bitbucket_service.py` — `BitbucketPlatformService` (App Password + REST API 2.0)
3. `backend/src/api/v1/webhooks_gitlab.py` — GitLab Webhook 엔드포인트 + `_verify_gitlab_token()`
4. `backend/src/api/v1/webhooks_bitbucket.py` — Bitbucket Webhook 엔드포인트 + `_verify_bitbucket_signature()`
5. `backend/src/api/v1/repos_gitlab.py` — GitLab 저장소 연동/목록 엔드포인트
6. `backend/src/api/v1/repos_bitbucket.py` — Bitbucket 저장소 연동/목록 엔드포인트

### 수정 필요

1. `backend/src/models/repository.py` — `platform`, `platform_repo_id`, `platform_url`, `platform_access_token_enc`, `external_username`, `platform_base_url` 컬럼 추가
2. `backend/src/api/v1/repos.py` — `GET /repos?platform=` 필터 지원, `platform` 필드 응답 포함
3. `backend/src/api/v1/router.py` — 신규 라우터 등록
4. `backend/src/config.py` — `GITLAB_WEBHOOK_SECRET`, `BITBUCKET_WEBHOOK_SECRET` 환경변수 추가
