# Quality Gate 결과 — F-01: 저장소 연동 및 스캔 트리거

검증일시: 2026-02-25 14:30  
브랜치: main  
검증 대상 파일: backend 7개, frontend 4개

---

## 보안

### Critical (즉시 수정 필요)

- [deps.py:55-61] **JWT 검증 미구현 — 인증 우회 가능**: `get_current_user()`가 항상 `HTTP 401`을 발생시키도록 `raise HTTPException(...)` 만 있고 실제 JWT 디코드/검증 로직이 없다. `CurrentUser` 의존성이 주입된 모든 엔드포인트(`GET /repos`, `POST /repos`, `DELETE /repos/{id}`, `GET /repos/github/installations`)는 현재 100% 401 오류를 반환하여 인증 기능 자체가 비활성 상태다. 이 상태로 배포되면 해당 API 전체가 동작하지 않는다.

- [repos.py:300-308] **인가 로직 결함 — 미인증 사용자가 저장소 삭제 가능**: `disconnect_repo`에서 `get_user_team_role()` 결과가 `"member"`일 때만 403을 반환한다. `role`이 `None`(팀 멤버가 아닌 외부인, 또는 DB 오류 시)인 경우에는 조건을 통과하여 저장소를 삭제할 수 있다. 올바른 허용 목록 방식은 `role not in ("owner", "admin")`으로 검사해야 한다.

- [github_app.py:59-61] **JWT 생성 실패 시 예외 묵살 + mock 토큰 반환**: `_generate_jwt()`의 `except Exception` 블록이 모든 예외를 삼키고 `"mock.jwt.token"` 문자열을 반환한다. 프로덕션 환경에서 Private Key가 잘못 설정된 경우 GitHub API 호출이 mock 토큰으로 진행되어 401 응답을 받게 되며, 실패 원인을 알 수 없다. 또한 설계서(결정 2)에서 PyJWT를 선택했으나 코드는 `python-jose`(`from jose import jwt`)를 사용하고 있다.

### Warning (권장 수정)

- [webhook_handler.py:85-95] **Race condition — 중복 스캔 방지 로직**: `has_active_scan()` 조회와 `enqueue_scan()` 호출 사이에 다른 Webhook 이벤트가 동시에 도달하면 동일 저장소에 두 개의 스캔이 큐잉될 수 있다. 설계서(9-2절)에서 "필요시 Redis 분산 잠금 적용"을 언급했으나 PoC 수준이라도 이 위험을 주석으로 명시해야 한다.

- [repos.py:109-120] **광범위한 `except Exception` — 에러 원인 은폐**: `get_user_team_role()`에서 모든 예외를 잡아 `None`을 반환한다. DB 접속 오류, 스키마 불일치 등 심각한 오류가 조용히 무시되며, `None` 반환이 인가 로직 결함(Critical 항목)과 결합되어 보안 문제를 일으킨다.

- [repos.py:155-196] **list_github_installations — 설치 ID를 첫 번째 저장소에서 임의 추출**: `installation_id`를 현재 사용자와 무관하게 DB의 첫 번째 저장소에서 가져온다. 여러 사용자가 존재하면 잘못된 installation의 저장소 목록이 반환된다. 설계서 6-4절의 pseudocode(`GET /user/installations`)와 불일치한다.

- [webhook_handler.py:192-200] **handle_installation_created — 팀 연결 미구현**: 신규 저장소 생성 시 `team_id=uuid.uuid4()`(임의 UUID)를 사용한다. 이 저장소는 어느 사용자의 팀에도 속하지 않아 `GET /repos` 조회에서 영구적으로 누락된다. 설계서 6-1절에서 `sender.id -> User -> TeamMember -> Team` 경로로 팀 조회를 요구하나 구현되지 않았다("PoC에서는 임시 팀 ID 사용" 주석).

- [scan_orchestrator.py:108-112] **RQ enqueue에 `Retry` 및 `job_timeout` 미적용**: 설계서 6-3절 pseudocode에서 `retry=Retry(max=MAX_RETRY_COUNT), job_timeout="10m"` 적용을 요구했으나, 실제 코드는 이 옵션 없이 `enqueue()`를 호출한다. 인수조건 "Webhook 수신 실패 시 재시도 로직 동작 (최대 3회)"를 충족하지 못한다.

- [repos.py:49-56] **N+1 성능 문제 — count 쿼리 비효율**: `get_repos_by_team()`에서 전체 레코드를 한 번 조회해 Python에서 `len()`으로 total을 계산한 뒤, 동일한 쿼리에 `LIMIT`/`OFFSET`을 붙여 다시 실행한다. 데이터가 많을수록 첫 번째 쿼리가 모든 행을 로드하므로 비효율적이다. `SELECT COUNT(*)` 서브쿼리를 별도로 실행해야 한다.

- [repos.py:316-345] **삭제 전 count 쿼리가 실제 삭제 결과와 불일치**: 취소 처리 후 잔여 스캔 수를 `SELECT`로 세지만, CASCADE 삭제 이후에는 이 값을 확인하지 않는다. `deleted_scans_count`는 "취소 처리된 진행 중 스캔"이 아니라 "전체 스캔 수"를 반환하여 의미가 다르다.

- [github_app.py:14] **모듈 수준 인메모리 캐시 — 멀티 프로세스 환경 위험**: `_token_cache`가 모듈 전역 딕셔너리로 선언되어 있다. 설계서(결정 3)에서 "단일 프로세스 PoC"임을 명시했으나, 향후 Gunicorn 멀티 워커로 배포 시 워커 간 캐시 불일치가 발생한다. 설계 결정을 코드 주석에 명시할 것을 권장한다.

### 통과

- [webhooks.py:37-44] HMAC-SHA256 서명 검증이 `hmac.compare_digest()`로 타이밍 공격 방어 구현 — 정상
- [webhooks.py:31-34] 서명 헤더 누락 및 `sha256=` 접두사 없는 경우 즉시 `False` 반환 — 정상
- [config.py] 시크릿 키(JWT_SECRET_KEY, GITHUB_APP_PRIVATE_KEY 등) 모두 환경변수로 관리, 하드코딩 없음 — 정상
- [.gitignore] `.env` 및 `.env.*`가 gitignore에 포함, `.env.example`만 추적 — 정상
- [main.py:41] 프로덕션 환경에서 `/docs`, `/redoc` 비활성화 — 정상
- [main.py:47-53] CORS 설정이 환경변수 기반 allowlist, wildcard 없음 — 정상
- [models] SQLAlchemy ORM 사용, raw SQL 없음 — SQL Injection 없음
- [repos-api.ts] 프론트엔드에서 dangerouslySetInnerHTML 미사용 — XSS 없음

---

## 성능

### Critical

없음

### Warning

- [repos.py:49-56] **N+1 유사 패턴 — 카운트를 위한 전체 행 로드**: 위 보안/코드 품질 항목과 동일. `SELECT *`로 전체 행을 로드 후 Python `len()`으로 카운트하므로, 저장소가 수천 개이면 심각한 성능 저하가 발생한다. `func.count()`를 사용한 별도 COUNT 쿼리가 필요하다.

- [webhook_handler.py:73-78] **push 페이로드 파일 중복 누적**: 여러 커밋에서 동일 파일이 반복되면 `changed_py_files`에 중복이 쌓인다. `set()`을 사용해 중복을 제거해야 한다. (기능 영향은 적으나 불필요한 재스캔 가능성)

- [scan_orchestrator.py:51-52] **Redis 연결이 요청마다 생성**: `ScanOrchestrator.__init__`에서 `redis.from_url()`을 매번 호출한다. Webhook 핸들러와 repos 엔드포인트가 요청마다 새 `ScanOrchestrator` 인스턴스를 생성하여(webhooks.py:86, repos.py:270) Redis 연결 비용이 발생한다. 앱 수준 싱글턴이나 lifespan 관리가 권장된다.

### 통과

- 설계서 5-3절 인덱스 계획이 Alembic 마이그레이션(`001_add_f01_columns.py`)에 반영됨 — `idx_scan_job_repo_active`(부분 인덱스), `idx_repository_installation` 모두 적용
- Webhook 핸들러가 DB 조회 + 큐 등록만 수행하고 실제 스캔은 워커에 위임 — 비동기 구조 정상
- `has_active_scan()`에 `.limit(1)` 적용 — 불필요한 전체 스캔 없음
- GitHub PR 파일 목록 조회 시 `per_page=100` 페이지네이션 처리 — 대용량 PR 정상 처리
- `GET /repos` 엔드포인트에 `page`, `per_page` 파라미터 지원 — 목록 페이지네이션 구현

---

## 설계/문서 일치

### 설계 불일치

- [github_app.py vs 설계서 결정 2] **JWT 라이브러리 불일치**: 설계서(결정 2)에서 **PyJWT**를 선택했으나 실제 코드는 `from jose import jwt`(`python-jose`)를 사용한다.

- [repos.py:155-176 vs 설계서 6-4절] **list_github_installations 구현 미흡**: 설계 pseudocode는 `current_user의 GitHub Access Token으로 /user/installations 호출`을 요구하나, 구현은 DB에서 임의의 첫 번째 `installation_id`를 가져와 사용한다. 사용자별 격리가 없다.

- [scan_orchestrator.py:108-112 vs 설계서 6-3절] **RQ Retry 옵션 미적용**: 설계서에서 `retry=Retry(max=MAX_RETRY_COUNT), job_timeout="10m"` 명시했으나 실제 코드에는 미적용.

- [webhook_handler.py:192-200 vs 설계서 6-1절] **installation.created의 팀 연결 미구현**: 설계서의 pseudocode 2-3 단계(`sender.id -> User -> Team`)가 구현되지 않았고 임시 UUID 처리 중.

### 문서 불일치

- [repos.py:300-308 vs API 문서 4절] **DELETE 403 조건 불일치**: API 스펙 문서에서 403은 "member 역할"에 대해 반환하도록 명시하나, 코드는 `role == "member"`만 차단하고 `role is None`(팀 비소속 외부인)은 통과시킨다.

- [docs/db/F-01-repo-integration.md] **DB 스키마 문서와 모델 일치 확인**: `repository` 테이블의 `is_initial_scan_done`, `scan_job` 테이블의 `scan_type`/`retry_count`/`changed_files` 컬럼이 모두 정상 반영됨. 인덱스도 Alembic 마이그레이션에 일치 — 정상.

### 인수조건 충족 현황

- ✅ GitHub App으로 설치 후 저장소 목록 조회 및 연동 API 구조 구현 (`GET /repos/github/installations`, `POST /repos`) — 단, 인증 미구현으로 현재 동작 불가
- ✅ PR 생성 이벤트 수신 시 자동 스캔 시작 (`handle_pull_request`) — Webhook 서명 검증 포함
- ✅ 브랜치 푸시 이벤트 수신 시 자동 스캔 시작 (`handle_push`) — 기본 브랜치 + Python 파일 필터 적용
- ✅ 웹 UI 수동 스캔 트리거 버튼 구현 (`ScanTriggerButton` 컴포넌트) — 단, 백엔드 인증 미구현으로 동작 불가
- ✅ 연동 후 초기 스캔 수행 — `installation.created` 이벤트 및 `POST /repos` 모두 `enqueue_scan(scan_type="initial")` 호출
- ❌ Webhook 수신 실패 시 재시도 로직 (최대 3회) — RQ `Retry` 옵션 미적용으로 미충족
- ✅ 연동 해제 시 관련 데이터 정리 — `DELETE /repos/{id}` 구현, CASCADE 삭제 설정됨

---

## 시각 검증

⏭️ 생략: ui-spec.md 파일이 존재하지 않음

---

## 종합 판정

FAIL — Critical 이슈 3건, Warning 이슈 8건

### Critical 이슈 목록 (수정 후 재검증 필요)

1. **[deps.py:55-61] JWT 검증 미구현** — `get_current_user()`가 TODO만 있고 항상 401 반환. 인증이 필요한 모든 API 동작 불가.
2. **[repos.py:300-308] 인가 로직 결함** — `role is None`(외부인)이 owner/admin 전용 `DELETE /repos/{id}`를 실행할 수 있음.
3. **[github_app.py:59-61] JWT 생성 실패 silent catch + mock 토큰 반환** — Private Key 설정 오류를 숨기고 잘못된 토큰으로 GitHub API 호출 진행.

